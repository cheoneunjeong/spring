<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.spring.mapper.SurveyMapper">
	
	<select id="getsurveylist" parameterType="Integer" resultType="Survey">
		SELECT * FROM
						(select @rownum := @rownum-1 as rownum,
					ta.*
		FROM 				
						survey ta, 
					 (select @rownum := (select COUNT(*)-#{page}+1 from survey ta)) tb 
		ORDER BY 	datetime asc

		LIMIT  		#{page},3)a
	</select>
	
	<select id="getPostCount" resultType="Integer">
		SELECT count(*) count FROM survey
	</select>
	
	<select id="search_t" parameterType="map" resultType="Survey">
		select * FROM
						(SELECT     @ROWNUM := @ROWNUM -1 AS rownum,
						ta.*
		FROM       
						(SELECT * FROM survey WHERE title LIKE #{s} ) ta, 
        				(SELECT @ROWNUM := (SELECT COUNT(*)-#{page}+1 
        				FROM (SELECT * FROM survey WHERE title LIKE #{s} ) ta)) tb
		order BY 	DATETIME asc
		LIMIT #{page},3)a
	</select>

	<select id="search_w" parameterType="map" resultType="Survey">
		select * FROM
						(SELECT     @ROWNUM := @ROWNUM -1 AS rownum,
						ta.*
		FROM       
						(SELECT * FROM survey WHERE writer LIKE #{s} ) ta, 
        				(SELECT @ROWNUM := (SELECT COUNT(*)-#{page}+1 
        				FROM (SELECT * FROM survey WHERE writer LIKE #{s} ) ta)) tb
		order BY 	DATETIME asc
		LIMIT #{page},3)a
	</select>
	
	<select id="SearchPostCount_t" resultType="String">
		SELECT count(*) count FROM survey where title = #{s}
	</select>

	<select id="SearchPostCount_w" resultType="String">
		SELECT count(*) count FROM survey where writer = #{s}
	</select>	
	
	<insert id="regSurvey" parameterType="Survey">  
        INSERT INTO	survey (
        	title,
        	disc,
        	writer
      ) VALUES (
      		#{title},
      		#{disc},
      		#{writer}
         )
	</insert>
	
	<insert id="regQuestion" parameterType="Survey">  
       <foreach collection="questions" item="question" separator=" , ">
	        INSERT INTO	question (
	        	q,
	        	t,
	        	s_num
	      ) VALUES 
	      
	      		(#{question.q}, #{question.t},
	      		(select s_num FROM survey ORDER BY 	  s_num DESC
							  LIMIT 1)
	      		)
      </foreach>
	</insert>
	
	<insert id="regAnswer" parameterType="Survey">  
       <foreach collection="answers" item="answer" separator=" , ">
	        INSERT INTO	answer (
	        	answer,
	        	q
	      ) VALUES 
	      	(
	      		#{answer.answer},
	    </foreach>
	    <foreach collection="questions" item="question" separator=" , ">
	      		#{question.q}
	      	)
    	 </foreach>
	</insert>
	
</mapper>